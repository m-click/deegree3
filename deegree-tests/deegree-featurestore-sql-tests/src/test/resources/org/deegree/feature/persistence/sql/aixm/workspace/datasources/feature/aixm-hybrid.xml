<SQLFeatureStore configVersion="3.4.0" xmlns="http://www.deegree.org/datasource/feature/sql" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.deegree.org/datasource/feature/sql http://schemas.deegree.org/datasource/feature/sql/3.4.0/sql.xsd"
  xmlns:gmd="http://www.isotc211.org/2005/gmd" xmlns:aixm="http://www.aixm.aero/schema/5.1" xmlns:message="http://www.aixm.aero/schema/5.1/message" xmlns:xlink="http://www.w3.org/1999/xlink"
  xmlns:gml="http://www.opengis.net/gml/3.2">

  <JDBCConnId>deegree-test</JDBCConnId>
  <DisablePostFiltering />

  <StorageCRS srid="0" dim="2D">urn:ogc:def:crs:EPSG::4326</StorageCRS>

  <GMLSchema>../../appschemas/aixm/message/AIXM_BasicMessage.xsd</GMLSchema>
  <GMLSchema>../../appschemas/aixm/event/Event_Features.xsd</GMLSchema>

  <CustomReferenceResolver>org.deegree.feature.persistence.FeatureStoreGmlIdentifierResolver</CustomReferenceResolver>

  <!-- Common mapping for every feature type -->
  <FeatureTypeMapping name="gml:AbstractFeature" table="aixm_feature" typeColumn="type">
    <FIDMapping prefix="uuid.">
      <Column name="uuid" type="string" />
      <UUIDGenerator />
    </FIDMapping>

    <Complex path="gml:identifier">
      <Primitive path="text()" mapping="gml_identifier" />
      <Primitive path="@codeSpace" mapping="'urn:uuid:'" />
    </Complex>

    <Geometry path="gml:boundedBy" mapping="gml_bounded_by" />

  </FeatureTypeMapping>

  <!-- Mapping augmentation for AIXM feature types with aixm:timeSlice properties -->
  <FeatureTypeMapping name="aixm:AerialRefuelling aixm:AeronauticalGroundLight aixm:AirTrafficControlService aixm:AirTrafficManagementService aixm:AircraftGroundService aixm:AircraftStand aixm:AirportClearanceService aixm:AirportHeliport aixm:AirportHeliportCollocation aixm:AirportHotSpot aixm:AirportProtectionAreaMarking aixm:AirportSuppliesService aixm:Airspace aixm:AirspaceBorderCrossing aixm:AltimeterSource aixm:AngleIndication aixm:ApproachLightingSystem aixm:Apron aixm:ApronElement aixm:ApronLightSystem aixm:ApronMarking aixm:ArrestingGear aixm:ArrivalFeederLeg aixm:ArrivalLeg aixm:AuthorityForAirspace aixm:Azimuth aixm:ChangeOverPoint aixm:CheckpointINS aixm:CheckpointVOR aixm:CirclingArea aixm:DME aixm:DeicingArea aixm:DeicingAreaMarking aixm:DepartureLeg aixm:DesignatedPoint aixm:DirectionFinder aixm:DistanceIndication aixm:Elevation aixm:FinalLeg aixm:FireFightingService aixm:FlightRestriction aixm:FloatingDockSite aixm:GeoBorder aixm:Glidepath aixm:GroundTrafficControlService aixm:GuidanceLine aixm:GuidanceLineLightSystem aixm:GuidanceLineMarking aixm:HoldingAssessment aixm:HoldingPattern aixm:InformationService aixm:InitialLeg aixm:InstrumentApproachProcedure aixm:IntermediateLeg aixm:Localizer aixm:MarkerBeacon aixm:MarkingBuoy aixm:MissedApproachLeg aixm:NDB aixm:Navaid aixm:NavigationArea aixm:NavigationAreaRestriction aixm:NonMovementArea aixm:ObstacleArea aixm:OrganisationAuthority aixm:PassengerLoadingBridge aixm:PassengerService aixm:PilotControlledLighting aixm:PrecisionApproachRadar aixm:PrimarySurveillanceRadar aixm:ProcedureDME aixm:RadarSystem aixm:RadioCommunicationChannel aixm:RadioFrequencyArea aixm:Road aixm:Route aixm:RouteDME aixm:RouteSegment aixm:RulesProcedures aixm:Runway aixm:RunwayBlastPad aixm:RunwayCentrelinePoint aixm:RunwayDirection aixm:RunwayDirectionLightSystem aixm:RunwayElement aixm:RunwayMarking aixm:RunwayProtectArea aixm:RunwayProtectAreaLightSystem aixm:RunwayVisualRange aixm:SDF aixm:SafeAltitudeArea aixm:SeaplaneLandingArea aixm:SeaplaneRampSite aixm:SearchRescueService aixm:SecondarySurveillanceRadar aixm:SignificantPointInAirspace aixm:SpecialDate aixm:SpecialNavigationStation aixm:SpecialNavigationSystem aixm:StandMarking aixm:StandardInstrumentArrival aixm:StandardInstrumentDeparture aixm:StandardLevelColumn aixm:StandardLevelSector aixm:StandardLevelTable aixm:SurveyControlPoint aixm:TACAN aixm:TaxiHoldingPosition aixm:TaxiHoldingPositionLightSystem aixm:TaxiHoldingPositionMarking aixm:Taxiway aixm:TaxiwayElement aixm:TaxiwayLightSystem aixm:TaxiwayMarking aixm:TerminalArrivalArea aixm:TouchDownLiftOff aixm:TouchDownLiftOffLightSystem aixm:TouchDownLiftOffMarking aixm:TouchDownLiftOffSafeArea aixm:Unit aixm:UnplannedHolding aixm:VOR aixm:VerticalStructure aixm:VisualGlideSlopeIndicator aixm:WorkArea" table="aixm_feature" typeColumn="type">
    <FIDMapping prefix="uuid.">
      <Column name="uuid" type="string" />
      <UUIDGenerator />
    </FIDMapping>

    <Complex path="aixm:featureMetadata">
      <Blob path="gmd:MD_Metadata" mapping="aixm_feature_metadata" />
    </Complex>

    <Complex path="aixm:timeSlice">
      <Join fromColumns="uuid" table="aixm_timeslice" toColumns="feature_uuid" orderColumns="id" fetchMode="join"/>
      <Blob path="*" mapping="binary_object"/>
      <Complex path="*">
        <Primitive path="@gml:id" mapping="attr_gml_id" />
        <Complex path="gml:validTime">
          <Primitive path="@nilReason" mapping="(CASE WHEN $0.gml_validtime_gml_timeinstant IS NULL AND $0.gml_validtime_gml_timeperiod_begin IS NULL AND $0.gml_validtime_gml_timeperiod_end IS NULL THEN 'inapplicable' ELSE NULL END)" type="string" />
          <Complex path="gml:TimeInstant">
            <Complex path="gml:timePosition">
              <Primitive path="text()" mapping="gml_validtime_gml_timeinstant" type="dateTime" />
            </Complex>
          </Complex>
          <Complex path="gml:TimePeriod">
            <Complex path="gml:beginPosition">
              <Primitive path="@indeterminatePosition" mapping="CASE WHEN gml_validtime_gml_timeperiod_begin IS NULL AND gml_validtime_gml_timeperiod_end IS NOT NULL THEN 'unknown' ELSE NULL END" type="string" />
              <Primitive path="text()" mapping="gml_validtime_gml_timeperiod_begin" type="dateTime" />
            </Complex>
            <Complex path="gml:endPosition">
              <Primitive path="@indeterminatePosition" mapping="CASE WHEN gml_validtime_gml_timeperiod_end IS NULL AND gml_validtime_gml_timeperiod_begin IS NOT NULL THEN 'unknown' ELSE NULL END" type="string" />
              <Primitive path="text()" mapping="gml_validtime_gml_timeperiod_end" type="dateTime" />
            </Complex>
          </Complex>
        </Complex>
        <Primitive path="aixm:interpretation" mapping="aixm_interpretation" />
        <Primitive path="aixm:sequenceNumber" mapping="aixm_sequence_number" />
        <Primitive path="aixm:correctionNumber" mapping="aixm_correction_number" />
        <Complex path="aixm:featureLifetime">
          <Complex path="gml:TimePeriod">
            <Complex path="gml:beginPosition">
              <Primitive path="@indeterminatePosition" mapping="CASE WHEN aixm_featurelifetime_gml_timeperiod_begin IS NULL THEN 'unknown' ELSE NULL END" type="string" />
              <Primitive path="text()" mapping="aixm_featurelifetime_gml_timeperiod_begin" type="dateTime" />
            </Complex>
            <Complex path="gml:endPosition">
              <Primitive path="@indeterminatePosition" mapping="CASE WHEN aixm_featurelifetime_gml_timeperiod_end IS NULL THEN 'unknown' ELSE NULL END" type="string" />
              <Primitive path="text()" mapping="aixm_featurelifetime_gml_timeperiod_end" type="dateTime" />
            </Complex>
          </Complex>
        </Complex>
      </Complex>
    </Complex>

  </FeatureTypeMapping>

  <TableSetup deriveTablesFromMapping="true">
    <TestSql>SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema='public' AND table_name='aixm_feature')</TestSql>
    <Sql>CREATE INDEX ON aixm_feature (gml_identifier)</Sql>
  </TableSetup>

</SQLFeatureStore>
